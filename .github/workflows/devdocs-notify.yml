name: DevDocs PR or Issue Creation Notifier

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification if DevDocs is mentioned
        uses: actions/github-script@v7
        with:
          script: |
            const fetch = (await import('node-fetch')).default;
            const isPR = !!context.payload.pull_request;
            const body = isPR
              ? context.payload.pull_request.body || ""
              : context.payload.issue.body || "";
            const mentioned = /@(?:10gen\/)?DevDocs/i.test(body);
            if (!mentioned) return;
            const user = isPR
              ? context.payload.pull_request.user.login
              : context.payload.issue.user.login;
            const link = isPR
              ? context.payload.pull_request.html_url
              : context.payload.issue.html_url;
            const message = {
              blocks: [
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: `:eyes: *@DevDocs* a PR was opened or issue created by *${user}*!\n\n` +
                          `*Repo:* ${context.repo.owner}/${context.repo.repo}\n` +
                          `*Type:* ${isPR ? "Pull Request" : "Issue"}\n` +
                          `<${link}|View on GitHub>`
                  }
                }
              ]
            };
            const url = process.env.SLACK_WORKFLOW_WEBHOOK;
            await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(message),
            });
        env:
          SLACK_WORKFLOW_WEBHOOK: ${{ secrets.SLACK_WORKFLOW_WEBHOOK }}
