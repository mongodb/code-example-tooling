# Workflow Configuration File
# This file should be placed at: .copier/workflows/config.yaml (in source repo)
# Referenced from main config file with:
#   workflow_configs:
#     - source: "repo"
#       repo: "mongodb/docs-sample-apps"
#       branch: "main"
#       path: ".copier/workflows/config.yaml"

# ============================================================================
# LOCAL DEFAULTS
# ============================================================================
# These defaults apply to all workflows in this file
# They override main config defaults but can be overridden by individual workflows

defaults:
  commit_strategy:
    type: "pull_request"
    auto_merge: false
  deprecation_check:
    enabled: true
    file: "deprecated_examples.json"
  exclude:
    - "**/.env"
    - "**/.env.*"
    - "**/node_modules/**"
    - "**/.DS_Store"
    - "\\.gitignore$"
    - "README.md$"

# ============================================================================
# WORKFLOWS
# ============================================================================
# Each workflow defines a complete source → destination mapping

workflows:
  # --------------------------------------------------------------------------
  # MFlix Java Application
  # --------------------------------------------------------------------------
  - name: "mflix-java"
    destination:
      repo: "mongodb/sample-app-java-mflix"
      branch: "main"
    transformations:
      - move: { from: "mflix/client", to: "client" }
      - move: { from: "mflix/server/java-spring", to: "server" }
      - copy: { from: "mflix/README-JAVA-SPRING.md", to: "README.md" }
      - copy: { from: "mflix/.gitignore-java", to: ".gitignore" }
    commit_strategy:
      $ref: "../strategies/mflix-pr-strategy.yaml"

  # --------------------------------------------------------------------------
  # MFlix Node.js Application
  # --------------------------------------------------------------------------
  - name: "mflix-nodejs"
    # source.repo and source.branch inherited from workflow config reference
    destination:
      repo: "mongodb/sample-app-nodejs-mflix"
      branch: "main"
    transformations:
      - move: { from: "mflix/client", to: "client" }
      - move: { from: "mflix/server/js-express", to: "server" }
      - copy: { from: "mflix/README-JAVASCRIPT-EXPRESS.md", to: "README.md" }
      - copy: { from: "mflix/.gitignore-js", to: ".gitignore" }
    commit_strategy:
      $ref: "../strategies/mflix-pr-strategy.yaml"

  # --------------------------------------------------------------------------
  # MFlix Python Application
  # --------------------------------------------------------------------------
  - name: "mflix-python"
    # source.repo and source.branch inherited from workflow config reference
    destination:
      repo: "mongodb/sample-app-python-mflix"
      branch: "main"
    transformations:
      - move: { from: "mflix/client", to: "client" }
      - move: { from: "mflix/server/python-fastapi", to: "server" }
      - copy: { from: "mflix/README-PYTHON-FASTAPI.md", to: "README.md" }
      - copy: { from: "mflix/.gitignore-python", to: ".gitignore" }
    commit_strategy:
      $ref: "../strategies/mflix-pr-strategy.yaml"

# ============================================================================
# BENEFITS OF THIS STRUCTURE
# ============================================================================
#
# 1. CO-LOCATION
#    - Workflow config lives with source code
#    - Easy to find and update
#    - Version controlled with source
#
# 2. OWNERSHIP
#    - Source repo team owns the workflow config
#    - Can update without touching central config
#    - Clear responsibility
#
# 3. TESTING
#    - Can test workflow config changes in source repo
#    - PR reviews include workflow changes
#    - Easy to validate before merging
#
# 4. SCALABILITY
#    - Each source repo has its own config
#    - No central bottleneck
#    - Easy to add new workflows
#
# 5. AUTOMATIC CONTEXT INFERENCE
#    - No need to specify source.repo and source.branch in workflows
#    - Automatically inherited from the workflow config reference
#    - Less redundancy, cleaner configuration
#    - Can still override if needed (e.g., different branch)
#
# ============================================================================
# SOURCE CONTEXT INFERENCE
# ============================================================================
#
# When a workflow config is referenced from a source repo, workflows can omit
# source.repo and source.branch - they're automatically inferred!
#
# EXAMPLE 1: Fully inferred (most common)
#   - name: "my-workflow"
#     # source.repo and source.branch inherited from workflow config reference
#     destination:
#       repo: "mongodb/dest-repo"
#     transformations:
#       - move: { from: "src", to: "dest" }
#
# EXAMPLE 2: Override branch only
#   - name: "my-workflow-develop"
#     source:
#       branch: "develop"  # Override branch, repo still inferred
#     destination:
#       repo: "mongodb/dest-repo"
#     transformations:
#       - move: { from: "src", to: "dest" }
#
# EXAMPLE 3: Explicit source (if needed)
#   - name: "cross-repo-workflow"
#     source:
#       repo: "mongodb/other-repo"  # Explicitly specify different repo
#       branch: "main"
#     destination:
#       repo: "mongodb/dest-repo"
#     transformations:
#       - move: { from: "src", to: "dest" }
#
# ============================================================================
# USING REFERENCES FOR REUSABILITY
# ============================================================================
#
# ✅ $ref support is now fully implemented!
#
# For better organization, you can extract common parts into separate files:
#
# .copier/
#   workflows/
#     config.yaml                     # This file (references others)
#   transformations/
#     mflix-java.yaml                 # Java transformations
#     mflix-nodejs.yaml               # Node.js transformations
#     mflix-python.yaml               # Python transformations
#   strategies/
#     mflix-pr-strategy.yaml          # Common PR strategy
#   common/
#     mflix-excludes.yaml             # Common exclude patterns
#
# Then use $ref to reference them (paths are relative to this file):
#
# workflows:
#   - name: "mflix-java"
#     # source.repo and source.branch inherited from workflow config reference
#     destination:
#       repo: "mongodb/sample-app-java-mflix"
#       branch: "main"
#     transformations:
#       $ref: "../transformations/mflix-java.yaml"    # ../ goes up to .copier/
#     commit_strategy:
#       $ref: "../strategies/mflix-pr-strategy.yaml"  # ../ goes up to .copier/
#     exclude:
#       $ref: "../common/mflix-excludes.yaml"         # ../ goes up to .copier/
#
# ============================================================================
# ADDING A NEW WORKFLOW
# ============================================================================
#
# To add a new workflow to this source repo:
#
# 1. Add a new workflow entry to this file
# 2. Define destination and transformations
# 3. Optionally override commit strategy
# 4. Commit and push to source repo
# 5. No changes needed to main config!
#
# Example (with source context inference):
#
# - name: "new-app-java"
#   # source.repo and source.branch inherited automatically
#   destination:
#     repo: "mongodb/sample-app-java-newapp"
#     branch: "main"
#   transformations:
#     - move: { from: "newapp/client", to: "client" }
#     - move: { from: "newapp/server/java", to: "server" }
#
# ============================================================================
# TESTING WORKFLOW CONFIGS
# ============================================================================
#
# You can test workflow configs locally before deploying:
#
# 1. Create a test config file
# 2. Use DRY_RUN=true to test without making changes
# 3. Validate transformations work as expected
# 4. Check PR titles and bodies
#
# ============================================================================

